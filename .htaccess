# ============================================
# HTACCESS PARA PORTAFOLIO - JODANI.CL
# Frontend React + Backend Node.js
# ============================================

# Activar RewriteEngine
RewriteEngine On

# ============================================
# SEGURIDAD Y HTTPS
# ============================================

# Redirigir HTTP a HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# PROXY PARA BACKEND NODE.JS (Puerto 3001)
# ============================================

# Proxy para peticiones /api/* hacia Node.js en puerto 3001
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ http://127.0.0.1:3001/api/$1 [P,L]

# Proxy para acceso directo al backend sin /api (opcional)
# RewriteCond %{REQUEST_URI} ^/backend/
# RewriteRule ^backend/(.*)$ http://127.0.0.1:3001/$1 [P,L]

# ============================================
# REACT ROUTER - SPA (Single Page Application)
# ============================================

# No aplicar rewrite a archivos estáticos
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# No aplicar rewrite a rutas de API
RewriteCond %{REQUEST_URI} !^/api/

# Redirigir todas las rutas al index.html para React Router
RewriteRule ^.*$ /index.html [L]

# ============================================
# CORS HEADERS (Ya configurado en backend, pero por si acaso)
# ============================================

<IfModule mod_headers.c>
    # CORS para permitir peticiones desde el frontend
    Header set Access-Control-Allow-Origin "https://jodani.cl"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header set Access-Control-Allow-Credentials "true"
    
    # Responder a peticiones OPTIONS (preflight)
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]
</IfModule>

# ============================================
# CACHÉ PARA ARCHIVOS ESTÁTICOS
# ============================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Imágenes
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # CSS y JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    
    # HTML (no cachear)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ============================================
# COMPRESIÓN GZIP
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# ============================================
# SEGURIDAD ADICIONAL
# ============================================

# Prevenir listado de directorios
Options -Indexes

# Proteger archivos sensibles
<FilesMatch "^\.env|^\.git|package\.json|package-lock\.json">
    Order allow,deny
    Deny from all
</FilesMatch>
